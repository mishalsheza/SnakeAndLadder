name: CD Pipeline - Kubernetes Deployment

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  deployments: write

jobs:
  deploy-to-k8s:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Kubernetes Simulation
        run: |
          echo "=== Kubernetes Deployment Simulation ==="
          echo "Image to deploy: mishalsheza19/snake-ladder-app:latest"
          echo "Simulating Kubernetes deployment steps"

      - name: Create Kubernetes Manifests
        run: |
          mkdir -p k8s

          echo "apiVersion: apps/v1" > k8s/deployment.yaml
          echo "kind: Deployment" >> k8s/deployment.yaml
          echo "metadata:" >> k8s/deployment.yaml
          echo "  name: snake-ladder-app" >> k8s/deployment.yaml
          echo "spec:" >> k8s/deployment.yaml
          echo "  replicas: 2" >> k8s/deployment.yaml
          echo "  selector:" >> k8s/deployment.yaml
          echo "    matchLabels:" >> k8s/deployment.yaml
          echo "      app: snake-ladder" >> k8s/deployment.yaml
          echo "  template:" >> k8s/deployment.yaml
          echo "    metadata:" >> k8s/deployment.yaml
          echo "      labels:" >> k8s/deployment.yaml
          echo "        app: snake-ladder" >> k8s/deployment.yaml
          echo "    spec:" >> k8s/deployment.yaml
          echo "      containers:" >> k8s/deployment.yaml
          echo "        - name: snake-ladder" >> k8s/deployment.yaml
          echo "          image: mishalsheza19/snake-ladder-app:latest" >> k8s/deployment.yaml
          echo "          ports:" >> k8s/deployment.yaml
          echo "            - containerPort: 8080" >> k8s/deployment.yaml

          echo "apiVersion: v1" > k8s/service.yaml
          echo "kind: Service" >> k8s/service.yaml
          echo "metadata:" >> k8s/service.yaml
          echo "  name: snake-ladder-service" >> k8s/service.yaml
          echo "spec:" >> k8s/service.yaml
          echo "  selector:" >> k8s/service.yaml
          echo "    app: snake-ladder" >> k8s/service.yaml
          echo "  ports:" >> k8s/service.yaml
          echo "    - port: 80" >> k8s/service.yaml
          echo "      targetPort: 8080" >> k8s/service.yaml
          echo "  type: LoadBalancer" >> k8s/service.yaml

      - name: Simulate Deployment Commands
        run: |
          echo "kubectl apply -f k8s/deployment.yaml"
          echo "kubectl apply -f k8s/service.yaml"
          echo "kubectl rollout status deployment/snake-ladder-app"

      - name: Upload Kubernetes Manifests
        uses: actions/upload-artifact@v4
        with:
          name: kubernetes-manifests
          path: k8s/

      - name: DAST Test (Simulated)
        run: |
          echo "DAST simulation passed"
