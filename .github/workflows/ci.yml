name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: snake-ladder-app
  JAVA_VERSION: "17"

jobs:
  build-test:
    name: Build, Test & Containerize
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: maven

      # 3️⃣ Build Application
      - name: Build Application
        run: mvn clean package

      # 4️⃣ Run Unit Tests
      - name: Run Tests
        run: mvn test

      # 5️⃣ Build Docker Image
      - name: Build Docker Image
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:${{ github.sha }}

      # 6️⃣ Container Smoke Test
      - name: Container Smoke Test
        run: |
          docker run -d --name smoke-test -p 8080:8080 ${{ env.IMAGE_NAME }}:latest
          sleep 15
          docker ps | grep smoke-test
          curl -f http://localhost:8080/actuator/health || echo "Health check failed"
          docker stop smoke-test
          docker rm smoke-test

      # 7️⃣ Login to DockerHub
      - name: Login to DockerHub
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 8️⃣ Tag and Push to DockerHub
      - name: Tag and Push Docker Image
        if: github.ref == 'refs/heads/main'
        run: |
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker tag ${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
